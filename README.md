# 群聊黑名单插件

## 功能描述

群聊黑名单插件是一个用于控制机器人使用权限的插件，可以以群聊为粒度进行黑名单管理。被拉黑的群聊将无法使用机器人功能，就像机器人不存在一样。

## 主要特性

- **群聊级别的权限控制**：可以禁用特定群聊使用机器人功能
- **灵活的命令格式**：支持指定群号或操作当前群聊
- **网页面板配置**：支持在AstrBot网页面板中配置屏蔽的群聊
- **私聊不受影响**：私聊消息不受群聊黑名单影响
- **管理员权限**：只有管理员可以使用相关指令
- **早期拦截**：使用高优先级事件监听器确保在其他插件之前执行

## 指令说明

### 基础指令

| 指令 | 功能 | 使用场景 |
|------|------|----------|
| `/ban <群号>` | 禁用指定群聊使用机器人功能 | 在任意位置执行，指定群号 |
| `/ban` | 禁用当前群聊使用机器人功能 | 在需要禁用的群聊中执行 |
| `/pass <群号>` | 允许指定群聊使用机器人功能 | 在任意位置执行，指定群号 |
| `/pass` | 允许当前群聊使用机器人功能 | 在需要启用的群聊中执行 |
| `/banlist` | 查看当前黑名单状态 | 查看当前配置状态 |

### 功能控制指令

| 指令 | 功能 | 使用场景 |
|------|------|----------|
| `/pass-all` | 允许所有群聊使用机器人功能 | 恢复所有群聊的使用权限 |
| `/ban_enable` | 启用黑名单功能 | 临时启用插件功能 |
| `/ban_disable` | 禁用黑名单功能 | 临时禁用插件功能 |
| `/ban-help` | 显示帮助信息 | 查看所有指令说明 |

## 使用示例

### 场景1：禁用指定群聊
```
管理员发送：/ban 123456789
机器人回复：已禁用群聊 123456789 使用机器人的权限。
```

### 场景2：禁用当前群聊
```
管理员在群聊A中发送：/ban
机器人回复：已禁用群聊 123456789 使用机器人的权限。
```

### 场景3：允许指定群聊使用
```
管理员发送：/pass 987654321
机器人回复：已允许群聊 987654321 使用机器人功能。
```

### 场景4：查看当前状态
```
管理员发送：/banlist
机器人回复：被禁用的群聊: 123456789, 111222333
```

### 场景5：允许所有群聊使用
```
管理员发送：/pass-all
机器人回复：已允许所有群聊使用机器人功能。
```

## 网页面板配置

插件支持在AstrBot网页面板中进行配置：

1. **启用/禁用功能**：通过 `enable` 选项控制插件是否启用
2. **配置黑名单**：通过 `banned_groups` 数组配置初始的黑名单群聊列表

### 配置示例

```json
{
    "ban_config": {
        "enable": true,
        "banned_groups": ["123456789", "987654321"]
    }
}
```

### 配置管理

插件支持多种配置方式：

1. **网页面板配置**：通过 `_conf_schema.json` 定义的配置项
2. **持久化存储**：通过 `sp` 接口保存运行时修改的黑名单
3. **配置合并**：启动时合并配置文件和持久化存储的数据

### 已知限制

**参数不足指令的处理**：
- 对于参数不足的指令（如 `/wc`），可能会先显示错误信息再终止事件传播
- 这是因为AstrBot的异常处理机制会在事件终止之前发送错误信息
- 这是AstrBot框架的限制，无法完全避免

**影响范围**：
- 正常的指令和LLM对话会被完全拦截，不会显示任何响应
- 只有参数不足的指令可能会显示错误信息，但后续的事件传播仍会被终止

## 数据存储

插件的数据存储在以下位置：
- `ban_plugin_banned_groups`：被禁用的群聊列表（持久化存储）
- `ban_plugin_enable`：插件启用状态

## 注意事项

1. **管理员权限**：所有指令都需要管理员权限才能使用
2. **私聊不受影响**：私聊消息不会被黑名单功能拦截
3. **数据持久化**：配置数据会持久化保存，重启后仍然有效
4. **配置合并**：网页面板配置和持久化存储的黑名单会被合并
5. **早期拦截**：插件会在事件处理流程中尽早拦截被禁用的群聊
6. **参数不足指令**：对于参数不足的指令，可能会先显示错误信息再终止事件传播，这是框架限制

## 版本历史

- **v2.0.0**：重构为群聊级别的黑名单功能，支持指定群号，添加网页面板配置